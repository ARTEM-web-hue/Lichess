<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шахматы с компьютером</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            margin: 0;
            padding: 20px;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
        
        h1 {
            text-align: center;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 5px;
        }
        
        .subtitle {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .fen-input-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .fen-input {
            width: 80%;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #ffd700;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-family: monospace;
        }
        
        .fen-input::placeholder {
            color: #aaa;
        }
        
        .game-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        #board {
            width: 400px;
            height: 400px;
            border: 3px solid #5d4037;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            position: relative;
        }
        
        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        .light {
            background-color: #f0d9b5;
        }
        
        .dark {
            background-color: #b58863;
        }
        
        .selected {
            background-color: #aec6cf !important;
        }
        
        .possible-move::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: rgba(0, 128, 0, 0.5);
            border-radius: 50%;
        }
        
        .last-move {
            background-color: rgba(155, 199, 0, 0.4) !important;
        }
        
        .piece {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: grab;
        }
        
        .piece:active {
            cursor: grabbing;
        }
        
        .dragging {
            opacity: 0.7;
        }
        
        .info-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 30, 40, 0.8);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .status {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            background: rgba(50, 50, 70, 0.8);
        }
        
        .move-history {
            height: 200px;
            overflow-y: auto;
            background: rgba(20, 20, 30, 0.8);
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
        }
        
        .move-history h3 {
            margin-top: 0;
            color: #ffd700;
        }
        
        .move-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }
        
        .move-item {
            padding: 5px;
            background: rgba(70, 70, 90, 0.6);
            border-radius: 3px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            background: linear-gradient(to bottom, #ffd700, #ff9800);
            border: none;
            border-radius: 5px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
            background: linear-gradient(to bottom, #ffec8b, #ffa726);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .promotion-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .promotion-content {
            background: #2c3e50;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }
        
        .promotion-content h3 {
            margin-top: 0;
            color: #ffd700;
        }
        
        .promotion-pieces {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .promotion-piece {
            width: 60px;
            height: 60px;
            cursor: pointer;
            transition: transform 0.2s;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .promotion-piece:hover {
            transform: scale(1.1);
            background: rgba(255, 215, 0, 0.2);
        }
        
        .instructions {
            margin-top: 20px;
            background: rgba(30, 30, 40, 0.8);
            border-radius: 10px;
            padding: 15px;
        }
        
        .instructions h3 {
            color: #ffd700;
            margin-top: 0;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
                align-items: center;
            }
            
            #board {
                width: 90vw;
                height: 90vw;
                max-width: 400px;
                max-height: 400px;
            }
            
            .info-panel {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Шахматы с компьютером</h1>
        <p class="subtitle">Сделайте ход, компьютер ответит случайным образом</p>
        
        <div class="fen-input-container">
            <input type="text" id="fenInput" class="fen-input" 
                   placeholder="Введите FEN позицию (например: rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1)" 
                   value="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1">
            <button id="loadFenBtn" style="margin-left: 10px; padding: 10px;">Загрузить позицию</button>
        </div>
        
        <div class="game-container">
            <div id="board"></div>
            
            <div class="info-panel">
                <div class="status" id="status">Белые ходят</div>
                
                <div class="controls">
                    <button id="newGameBtn">Новая игра</button>
                    <button id="undoBtn">Отменить ход</button>
                    <button id="flipBoardBtn">Перевернуть доску</button>
                </div>
                
                <div class="move-history">
                    <h3>История ходов</h3>
                    <div class="move-list" id="moveList"></div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>Как играть:</h3>
            <ul>
                <li>Вы играете белыми фигурами</li>
                <li>Компьютер играет черными и делает случайные ходы</li>
                <li>Чтобы сделать ход, кликните на фигуру, затем на целевую клетку</li>
                <li>Или перетащите фигуру на нужную клетку</li>
                <li>При превращении пешки выберите фигуру из предложенных</li>
                <li>Цель игры - поставить мат королю противника</li>
                <li>Введите FEN позицию в поле выше и нажмите "Загрузить позицию"</li>
            </ul>
        </div>
    </div>
    
    <div class="promotion-modal" id="promotionModal">
        <div class="promotion-content">
            <h3>Выберите фигуру для превращения пешки</h3>
            <div class="promotion-pieces">
                <div class="promotion-piece" data-piece="q">
                    <span style="font-size: 40px;">♕</span>
                </div>
                <div class="promotion-piece" data-piece="r">
                    <span style="font-size: 40px;">♖</span>
                </div>
                <div class="promotion-piece" data-piece="b">
                    <span style="font-size: 40px;">♗</span>
                </div>
                <div class="promotion-piece" data-piece="n">
                    <span style="font-size: 40px;">♘</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация игры
            const game = new Chess();
            let selectedSquare = null;
            let possibleMoves = [];
            let promotionPending = null;
            let lastMove = null;
            let positionHistory = [];
            const $board = document.getElementById('board');
            const $status = document.getElementById('status');
            const $moveList = document.getElementById('moveList');
            const $fenInput = document.getElementById('fenInput');
            
            // Создание доски
            createBoard();
            
            // Обработчики событий
            document.getElementById('newGameBtn').addEventListener('click', newGame);
            document.getElementById('undoBtn').addEventListener('click', undoMove);
            document.getElementById('flipBoardBtn').addEventListener('click', flipBoard);
            document.getElementById('loadFenBtn').addEventListener('click', loadFenPosition);
            
            // Обработчики выбора фигуры для превращения
            document.querySelectorAll('.promotion-piece').forEach(piece => {
                piece.addEventListener('click', function() {
                    const pieceType = this.getAttribute('data-piece');
                    handlePromotion(pieceType);
                });
            });
            
            // Создание шахматной доски
            function createBoard() {
                $board.innerHTML = '';
                const boardPosition = game.board();
                
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const square = document.createElement('div');
                        const isLight = (row + col) % 2 === 0;
                        square.className = `square ${isLight ? 'light' : 'dark'}`;
                        square.dataset.row = row;
                        square.dataset.col = col;
                        square.dataset.square = String.fromCharCode(97 + col) + (8 - row);
                        
                        // Добавляем координаты
                        const piece = boardPosition[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.className = 'piece';
                            pieceElement.dataset.piece = `${piece.color}${piece.type}`;
                            pieceElement.innerHTML = `<span>${getPieceChar(piece.type, piece.color)}</span>`;
                            pieceElement.draggable = true;
                            
                            // Добавляем обработчики перетаскивания
                            pieceElement.addEventListener('dragstart', handleDragStart);
                            pieceElement.addEventListener('dragend', handleDragEnd);
                            
                            square.appendChild(pieceElement);
                        }
                        
                        // Добавляем обработчики событий для клетки
                        square.addEventListener('click', () => handleSquareClick(row, col));
                        square.addEventListener('dragover', handleDragOver);
                        square.addEventListener('drop', handleDrop);
                        
                        $board.appendChild(square);
                    }
                }
                
                // Подсвечиваем последний ход
                if (lastMove) {
                    highlightLastMove(lastMove);
                }
            }
            
            // Получение символа фигуры
            function getPieceChar(type, color) {
                const pieces = {
                    'wp': '♙', 'wr': '♖', 'wn': '♘', 'wb': '♗', 'wq': '♕', 'wk': '♔',
                    'bp': '♟', 'br': '♜', 'bn': '♞', 'bb': '♝', 'bq': '♛', 'bk': '♚'
                };
                return pieces[`${color}${type}`] || '';
            }
            
            // Обработка начала перетаскивания
            function handleDragStart(e) {
                const piece = e.target;
                const square = piece.parentElement;
                const squareName = square.dataset.square;
                
                // Если игра окончена или это фигура противника, отменяем перетаскивание
                if (game.game_over() || game.turn() === 'b') {
                    e.preventDefault();
                    return;
                }
                
                const pieceData = game.get(squareName);
                if (!pieceData || pieceData.color !== 'w') {
                    e.preventDefault();
                    return;
                }
                
                piece.classList.add('dragging');
                selectedSquare = squareName;
                showPossibleMoves(squareName);
                
                // Устанавливаем данные для перетаскивания
                e.dataTransfer.setData('text/plain', squareName);
                e.dataTransfer.effectAllowed = 'move';
            }
            
            // Обработка окончания перетаскивания
            function handleDragEnd(e) {
                e.target.classList.remove('dragging');
                clearHighlights();
                selectedSquare = null;
                possibleMoves = [];
            }
            
            // Обработка перетаскивания над клеткой
            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
            
            // Обработка сброса фигуры на клетку
            function handleDrop(e) {
                e.preventDefault();
                clearHighlights();
                
                if (!selectedSquare) return;
                
                const targetSquare = e.target.classList.contains('square') ? 
                    e.target : e.target.parentElement;
                const targetSquareName = targetSquare.dataset.square;
                
                if (selectedSquare === targetSquareName) {
                    selectedSquare = null;
                    return;
                }
                
                // Проверяем, является ли ход возможным
                const move = possibleMoves.find(m => m.to === targetSquareName);
                if (move) {
                    makeMove(selectedSquare, targetSquareName, move.promotion);
                }
                
                selectedSquare = null;
                possibleMoves = [];
            }
            
            // Обработка клика по клетке
            function handleSquareClick(row, col) {
                const squareName = String.fromCharCode(97 + col) + (8 - row);
                
                // Если игра окончена, ничего не делаем
                if (game.game_over()) return;
                
                // Если это ход компьютера, ничего не делаем
                if (game.turn() === 'b') return;
                
                // Если выбрана клетка для превращения, ничего не делаем
                if (document.getElementById('promotionModal').style.display === 'flex') return;
                
                // Если еще не выбрана клетка
                if (!selectedSquare) {
                    const piece = game.get(squareName);
                    // Проверяем, есть ли фигура и принадлежит ли она игроку
                    if (piece && piece.color === 'w') {
                        selectedSquare = squareName;
                        highlightSquare(row, col);
                        showPossibleMoves(squareName);
                    }
                    return;
                }
                
                // Если выбрана та же клетка - снимаем выделение
                if (selectedSquare === squareName) {
                    clearHighlights();
                    selectedSquare = null;
                    possibleMoves = [];
                    return;
                }
                
                // Проверяем, является ли ход возможным
                const move = possibleMoves.find(m => m.to === squareName);
                if (move) {
                    makeMove(selectedSquare, squareName, move.promotion);
                } else {
                    // Проверяем, выбрана ли другая фигура игрока
                    const piece = game.get(squareName);
                    if (piece && piece.color === 'w') {
                        clearHighlights();
                        selectedSquare = squareName;
                        highlightSquare(row, col);
                        showPossibleMoves(squareName);
                    } else {
                        clearHighlights();
                        selectedSquare = null;
                        possibleMoves = [];
                    }
                }
            }
            
            // Подсветка выбранной клетки
            function highlightSquare(row, col) {
                clearHighlights();
                const square = document.querySelector(`.square[data-row="${row}"][data-col="${col}"]`);
                if (square) {
                    square.classList.add('selected');
                }
            }
            
            // Показ возможных ходов
            function showPossibleMoves(square) {
                possibleMoves = game.moves({square: square, verbose: true});
                clearMoveHighlights();
                
                possibleMoves.forEach(move => {
                    const [col, row] = move.to;
                    const rowIndex = 8 - parseInt(row);
                    const colIndex = col.charCodeAt(0) - 97;
                    const squareElement = document.querySelector(`.square[data-row="${rowIndex}"][data-col="${colIndex}"]`);
                    if (squareElement) {
                        squareElement.classList.add('possible-move');
                    }
                });
            }
            
            // Подсветка последнего хода
            function highlightLastMove(move) {
                if (!move) return;
                
                // Убираем предыдущую подсветку
                document.querySelectorAll('.square').forEach(square => {
                    square.classList.remove('last-move');
                });
                
                // Подсвечиваем клетки последнего хода
                const fromSquare = document.querySelector(`.square[data-square="${move.from}"]`);
                const toSquare = document.querySelector(`.square[data-square="${move.to}"]`);
                
                if (fromSquare) fromSquare.classList.add('last-move');
                if (toSquare) toSquare.classList.add('last-move');
            }
            
            // Очистка подсветки
            function clearHighlights() {
                document.querySelectorAll('.square').forEach(square => {
                    square.classList.remove('selected', 'possible-move');
                });
            }
            
            // Очистка подсветки возможных ходов
            function clearMoveHighlights() {
                document.querySelectorAll('.square').forEach(square => {
                    square.classList.remove('possible-move');
                });
            }
            
            // Выполнение хода
            function makeMove(from, to, promotion) {
                // Сохраняем текущую позицию в истории
                positionHistory.push(game.fen());
                
                // Проверка, является ли ход легальным
                const move = game.move({
                    from: from,
                    to: to,
                    promotion: promotion || 'q' // По умолчанию превращаем в ферзя
                });
                
                if (move === null) {
                    clearHighlights();
                    selectedSquare = null;
                    possibleMoves = [];
                    positionHistory.pop(); // Удаляем последнюю позицию из истории
                    return;
                }
                
                lastMove = move;
                
                // Проверка на превращение пешки
                if (move.promotion) {
                    promotionPending = move;
                    document.getElementById('promotionModal').style.display = 'flex';
                    return;
                }
                
                // Обновление доски и статуса
                updateBoard();
                updateStatus();
                updateMoveHistory();
                
                clearHighlights();
                selectedSquare = null;
                possibleMoves = [];
                
                // Ход компьютера
                if (!game.game_over()) {
                    window.setTimeout(makeRandomMove, 500);
                }
            }
            
            // Ход компьютера (случайный)
            function makeRandomMove() {
                // Сохраняем текущую позицию в истории
                positionHistory.push(game.fen());
                
                if (game.game_over()) return;
                
                const possibleMoves = game.moves();
                if (possibleMoves.length === 0) return;
                
                // Выбор случайного хода
                const randomIndex = Math.floor(Math.random() * possibleMoves.length);
                const move = game.move(possibleMoves[randomIndex]);
                
                // Проверка на превращение
                if (move.promotion) {
                    // Для компьютера всегда превращаем в ферзя
                    game.undo();
                    game.move({
                        from: move.from,
                        to: move.to,
                        promotion: 'q'
                    });
                }
                
                lastMove = move;
                
                // Обновление доски и статуса
                updateBoard();
                updateStatus();
                updateMoveHistory();
            }
            
            // Обновление доски
            function updateBoard() {
                const boardPosition = game.board();
                
                // Очищаем доску
                document.querySelectorAll('.square').forEach(square => {
                    square.innerHTML = '';
                    square.classList.remove('last-move');
                });
                
                // Заполняем доску
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const squareName = String.fromCharCode(97 + col) + (8 - row);
                        const square = document.querySelector(`.square[data-square="${squareName}"]`);
                        
                        const piece = boardPosition[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.className = 'piece';
                            pieceElement.dataset.piece = `${piece.color}${piece.type}`;
                            pieceElement.innerHTML = `<span>${getPieceChar(piece.type, piece.color)}</span>`;
                            pieceElement.draggable = true;
                            
                            // Добавляем обработчики перетаскивания
                            pieceElement.addEventListener('dragstart', handleDragStart);
                            pieceElement.addEventListener('dragend', handleDragEnd);
                            
                            square.appendChild(pieceElement);
                        }
                    }
                }
                
                // Подсвечиваем последний ход
                if (lastMove) {
                    highlightLastMove(lastMove);
                }
            }
            
            // Обработка выбора превращения
            function handlePromotion(pieceType) {
                document.getElementById('promotionModal').style.display = 'none';
                
                if (promotionPending) {
                    game.undo();
                    game.move({
                        from: promotionPending.from,
                        to: promotionPending.to,
                        promotion: pieceType
                    });
                    
                    lastMove = {
                        from: promotionPending.from,
                        to: promotionPending.to,
                        promotion: pieceType
                    };
                    
                    promotionPending = null;
                    updateBoard();
                    updateStatus();
                    updateMoveHistory();
                    
                    // Ход компьютера
                    if (!game.game_over()) {
                        window.setTimeout(makeRandomMove, 500);
                    }
                }
            }
            
            // Обновление статуса игры
            function updateStatus() {
                let status = '';
                
                if (game.in_checkmate()) {
                    status = game.turn() === 'w' ? 'Мат! Черные выиграли' : 'Мат! Белые выиграли';
                } else if (game.in_draw()) {
                    status = 'Ничья';
                } else {
                    status = game.turn() === 'w' ? 'Белые ходят' : 'Черные ходят';
                    
                    if (game.in_check()) {
                        status += ', шах';
                    }
                }
                
                $status.innerHTML = status;
            }
            
            // Обновление истории ходов
            function updateMoveHistory() {
                const history = game.history({ verbose: true });
                $moveList.innerHTML = '';
                
                for (let i = 0; i < history.length; i++) {
                    const move = history[i];
                    const moveNumber = Math.floor(i / 2) + 1;
                    const isWhite = i % 2 === 0;
                    
                    if (isWhite) {
                        const moveItem = document.createElement('div');
                        moveItem.className = 'move-item';
                        moveItem.textContent = `${moveNumber}. ${move.san}`;
                        $moveList.appendChild(moveItem);
                    } else {
                        const lastItem = $moveList.lastChild;
                        lastItem.textContent += ` ${move.san}`;
                    }
                }
                
                // Прокрутка вниз
                $moveList.scrollTop = $moveList.scrollHeight;
            }
            
            // Переворот доски
            function flipBoard() {
                // В этой реализации просто показываем сообщение
                alert('Функция переворота доски не реализована в этой версии');
            }
            
            // Отмена хода
            function undoMove() {
                if (positionHistory.length > 0) {
                    const prevFen = positionHistory.pop();
                    game.load(prevFen);
                    lastMove = null;
                    selectedSquare = null;
                    possibleMoves = [];
                    promotionPending = null;
                    document.getElementById('promotionModal').style.display = 'none';
                    createBoard();
                    updateStatus();
                    updateMoveHistory();
                }
            }
            
            // Загрузка позиции из FEN
            function loadFenPosition() {
                const fen = $fenInput.value.trim();
                if (fen) {
                    try {
                        game.load(fen);
                        positionHistory = [];
                        lastMove = null;
                        selectedSquare = null;
                        possibleMoves = [];
                        promotionPending = null;
                        document.getElementById('promotionModal').style.display = 'none';
                        createBoard();
                        updateStatus();
                        updateMoveHistory();
                    } catch (e) {
                        alert('Неверный формат FEN позиции');
                    }
                }
            }
            
            // Новая игра
            function newGame() {
                game.reset();
                $fenInput.value = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";
                positionHistory = [];
                lastMove = null;
                selectedSquare = null;
                possibleMoves = [];
                promotionPending = null;
                document.getElementById('promotionModal').style.display = 'none';
                createBoard();
                updateStatus();
                updateMoveHistory();
            }
            
            // Инициализация
            updateStatus();
            updateMoveHistory();
        });
    </script>
</body>
</html>
