name: üîÑ –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç

on:
  repository_dispatch:
    types: [new-chat-message]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_TOKEN }}

      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        run: |
          mkdir -p creck
          touch creck/chat.json
          echo '[]' > creck/chat.json

      - name: –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        run: |
          echo "–î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${{ github.event.client_payload.user }}"
          NEW_MSG=$(jq -n \
            --arg user "${{ github.event.client_payload.user }}" \
            --arg text "${{ github.event.client_payload.text }}" \
            --arg time "${{ github.event.client_payload.time }}" \
            '{user: $user, text: $text, time: $time}')

          # –ß–∏—Ç–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          if [ -f creck/chat.json ]; then
            cat creck/chat.json > temp.json
          else
            echo "[]" > temp.json
          fi

          # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50
          jq --slurpfile new "$NEW_MSG" '. += $new | .[-50:]' temp.json > creck/chat.json

      - name: –ö–æ–º–º–∏—Ç
        run: |
          git config user.name "Chat Bot"
          git config user.email "bot@localhost"
          git add creck/chat.json
          git commit -m "üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${{ github.event.client_payload.user }}"
          git push
